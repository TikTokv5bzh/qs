<!DOCTYPE html>
<html dir="rtl">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة حروف</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* تعريف الخط المخصص محلياً */
        @font-face {
            font-family: 'AA-galaxy';
            src:
                url('./AA-GALAXY.woff2') format('woff2'),
                url('./AA-GALAXY.ttf') format('truetype'),
                url('./AA-GALAXY.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            /* --- الألوان --- */
            --color-bg: #8B5CF6;
            --color-border-vertical: #34D399;
            --color-border-horizontal: #FB923C;
            --color-cell-bg: #FFFFFF;
            --color-hex-outer-border: #333;
            --color-cell-text: #000000;
            --color-team1: var(--color-border-vertical);
            --color-team2: var(--color-border-horizontal);
            --color-text-light: #FFFFFF;
            --color-text-dark: #333333;
            --color-win-message-bg: rgba(0, 0, 0, 0.75);

            /* --- الأبعاد الأساسية للشكل السداسي --- */
            --hex-width: 85px;
            --hex-height: calc(var(--hex-width) * 0.8660254);
            --hex-clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);

            /* --- تعديلات التداخل لخلايا النحل المتلاصقة --- */
            --hex-margin-h: calc(var(--hex-width) * -0.1);
            --hex-margin-v-overlap: calc(var(--hex-height) * -0.2);
            --hex-stagger-offset: calc(var(--hex-width) * 0.75 / 2);

            --container-padding: 30px;

            /* --- أبعاد للخلايا السداسية الزخرفية --- */
            --hex-width-decorative: 55px; 
            --hex-height-decorative: calc(var(--hex-width-decorative) * 0.8660254);
        }
        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'AA-galaxy', sans-serif;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background-color: var(--color-bg); margin: 0; padding: 20px;
            position: relative; overflow-x: hidden; overflow-y: auto;
        }

        #game-content-wrapper {
            display: flex; flex-direction: column; align-items: center;
            position: relative; z-index: 1;
            background-color: #FFFFFF;
            padding: var(--container-padding);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 100%; max-width: 1000px;
            text-align: center;
            overflow: hidden; 
        }

        /* --- قسم زر الأسئلة (كان top-action-buttons-container) --- */
        #action-button-area { /* تم تغيير الاسم ليعكس الغرض العام أكثر */
            display: flex;
            justify-content: center; 
            position: relative; 
            z-index: 10; 
        }
        .action-button-style {
            padding: 10px 15px; /* تم تعديل الحشوة قليلاً */
            background-color: #4CAF50; color: white; border: none;
            border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background-color 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: auto; 
            min-width: 130px; /* تم تقليل الحد الأدنى للعرض */
            font-family: 'AA-galaxy', sans-serif;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-button-style:hover { background-color: #45a049; }
        .copy-message {
            font-size: 0.9rem; color: #4CAF50; opacity: 0; transition: opacity 0.3s ease;
            position: absolute; left: 50%; 
            transform: translateX(-50%); 
            bottom: 100%; /* تغيير ليظهر فوق الزر */
            margin-bottom: 8px; /* مسافة بين الرسالة والزر */
            background-color: rgba(0,0,0,0.75);
            padding: 6px 12px; border-radius: 5px; color: white; white-space: nowrap;
            pointer-events: none; font-family: 'AA-galaxy', sans-serif;
            z-index: 11; 
        }
        .button-with-message-wrapper { 
            position: relative; 
            width: auto; 
            display: inline-block; 
        }
        .copy-message.visible { opacity: 1; }


        .game-layout-row {
            display: flex; flex-direction: row; align-items: center;
            justify-content: center; gap: 30px; margin-bottom: 30px;
            flex-wrap: wrap; position: relative; z-index: 2;
        }

        #game-title-and-buttons {
            display: flex; flex-direction: column; align-items: center;
            gap: 20px; /* زيادة المسافة قليلاً لتعويض إزالة الزر من هنا */
            flex-shrink: 0;
        }

        #game-title-text {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; font-family: 'AA-galaxy', sans-serif;
            line-height: 0.9; padding: 10px; transform: skewX(-10deg);
            max-width: 250px; margin-left: auto; margin-right: auto;
        }

        #game-title-text span {
            display: block; font-weight: bold;
            text-shadow: -1px -1px 0 #2c2c2c, 1px -1px 0 #2c2c2c, -1px 1px 0 #2c2c2c, 1px 1px 0 #2c2c2c, 2px 2px 0 #4a4a4a, 3px 3px 0 #6a6a6a;
            white-space: nowrap; padding: 5px 0; cursor: pointer;
            transition: transform 0.2s ease; --random-x: 0px; --random-y: 0px;
            transform: translate(var(--random-x), var(--random-y));
        }
        #game-title-text span:hover { transform: translate(var(--random-x), var(--random-y)) scale(1.05); }
        #title-line-1 { font-size: 3.5rem; color: #FFD700; }
        #title-line-2 { font-size: 2.5rem; color: #4FC3F7; }
        #title-line-3 { font-size: 3.5rem; color: #EF5350; }

        .color-controls {
            /* margin-bottom: 30px; /* تمت الإزالة، ستتم إدارتها بواسطة الحاوية الأم */
            display: flex; justify-content: center; align-items: center; /* توسيط المحتوى */
            gap: 10px 20px; /* gap عمودي وأفقي */
            flex-wrap: wrap;
            position: relative; z-index: 2;
        }
        .color-controls > div { /* لتوسيط كل زوج من label و input */
            display: flex;
            flex-direction: column; /* label فوق input */
            align-items: center;
            gap: 5px;
        }
        .color-controls label { font-weight: bold; color: var(--color-text-dark); font-family: 'AA-galaxy', sans-serif; }
        .color-controls input[type="color"] { /* لضمان حجم مناسب لمربع اللون */
            width: 50px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #ccc;
            cursor: pointer;
        }


        #grid-layout-container {
            position: relative; padding: calc(var(--hex-height) * 0.75); width: fit-content;
            margin: 0 auto; border-radius: 15px; overflow: hidden; flex-shrink: 0;
        }
        #grid-background {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: conic-gradient(from 45deg at 50% 50%, var(--color-team2) 0deg 90deg, var(--color-team1) 90deg 180deg, var(--color-team2) 180deg 270deg, var(--color-team1) 270deg 360deg);
            z-index: 0; border-radius: 15px;
        }
        #hex-grid {
            display: flex; flex-direction: column; width: fit-content; position: relative;
            z-index: 1; margin: 0 auto;
        }
        .hex-row { display: flex; margin-bottom: var(--hex-margin-v-overlap); }
        .hex-row:last-child { margin-bottom: 0; }
        .hex-row:nth-child(even) { margin-inline-start: var(--hex-stagger-offset); }

        .grid-cell {
            position: relative; width: var(--hex-width); height: var(--hex-height);
            background-color: var(--color-cell-bg); cursor: pointer; clip-path: var(--hex-clip-path);
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            box-sizing: border-box; margin-right: var(--hex-margin-h);
        }
        .grid-cell:last-child { margin-right: 0; }
        .grid-cell:hover:not(.answered-team1):not(.answered-team2) { transform: scale(1.08); z-index: 5; }
        .cell-content {
            font-size: calc(var(--hex-width) * 0.45); max-width: calc(var(--hex-width) * 0.75);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            font-weight: bold; user-select: none; text-align: center; color: var(--color-cell-text);
            font-family: 'AA-galaxy' !important;
        }
        .grid-cell.answered-team1, .grid-cell.answered-team2 { cursor: default; }
        .grid-cell.answered-team1:hover, .grid-cell.answered-team2:hover { transform: scale(1); }
        .grid-cell.answered-team1 { background-color: var(--color-team1) !important; border-color: var(--color-team1) !important; }
        .grid-cell.answered-team2 { background-color: var(--color-team2) !important; border-color: var(--color-team2) !important; }
        .grid-cell.answered-team1 .cell-content, .grid-cell.answered-team2 .cell-content {
            color: var(--color-text-light) !important; display: none;
        }

        #team-buttons-area {
            display: flex; flex-direction: column; justify-content: center; gap: 15px;
            flex-wrap: wrap; min-height: 50px;
        }
        #team-buttons-area button {
            padding: 10px 20px; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer;
            color: var(--color-text-light); font-weight: bold; transition: background-color 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); font-family: 'AA-galaxy', sans-serif;
        }
        #team-buttons-area button:hover { opacity: 0.9; }
        #team-buttons-area .button-team1 { background-color: var(--color-team1); }
        #team-buttons-area .button-team2 { background-color: var(--color-team2); }
        #team-buttons-area .button-cancel { background-color: #EF4444; }

        #loading {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 1.3em; text-align: center;
            padding: 15px 25px; color: var(--color-text-light); font-weight: bold; background-color: var(--color-win-message-bg);
            border-radius: 8px; z-index: 30; max-width: 90%; display: block; font-family: 'AA-galaxy', sans-serif;
        }
        #loading.error-message { color: #FFCCCC; background-color: #8B0000; border: 1px solid #FFCCCC; }
        
        #win-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);
            color: white; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #win-overlay.visible { opacity: 1; visibility: visible; }
        .win-message-text {
            font-size: 4rem; font-weight: bold; margin-bottom: 20px; animation: pulse 1.5s infinite;
            font-family: 'AA-galaxy', sans-serif;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .restart-button {
            padding: 10px 20px; font-size: 1.2rem; background-color: #fff; color: #333;
            border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;
            font-family: 'AA-galaxy', sans-serif;
        }
        .restart-button:hover { background-color: #eee; }


        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 1; visibility: visible; transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .modal-content {
            background-color: #FFFFFF; padding: 30px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center; max-width: 400px;
            width: 90%; transform: translateY(0); transition: transform 0.3s ease;
            font-family: 'AA-galaxy', sans-serif;
        }
        .modal-overlay.hidden .modal-content { transform: translateY(-20px); }
        .modal-content h3 { font-size: 1.8rem; color: var(--color-text-dark); margin-bottom: 20px; font-weight: bold; }
        .modal-content input[type="text"] {
            width: calc(100% - 20px); padding: 12px; margin-bottom: 20px;
            border: 2px solid var(--color-team1); border-radius: 8px; font-size: 1.1rem;
            text-align: center; font-family: 'AA-galaxy', sans-serif; outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .modal-content input[type="text"]:focus { border-color: var(--color-team2); box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.3); }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .modal-buttons button {
            padding: 10px 25px; border: none; border-radius: 8px; font-size: 1.1rem;
            font-weight: bold; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'AA-galaxy', sans-serif; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .modal-buttons button.confirm-btn { background-color: var(--color-team1); color: white; }
        .modal-buttons button.confirm-btn:hover { background-color: #28a77a; transform: translateY(-2px); }
        .modal-buttons button.cancel-btn { background-color: #EF4444; color: white; }
        .modal-buttons button.cancel-btn:hover { background-color: #dc2626; transform: translateY(-2px); }

        /* --- أنماط الشبكات الزخرفية --- */
        .decorative-hex-grid {
            position: absolute;
            z-index: 0; 
            pointer-events: none; 
        }
        .decorative-hex-grid .hex-row {
            display: flex;
            margin-bottom: calc(var(--hex-height-decorative) * -0.2);
        }
        .decorative-hex-grid .hex-row:nth-child(even) {
            margin-inline-start: calc(var(--hex-width-decorative) * 0.75 / 2);
        }
        .decorative-hex-grid .grid-cell {
            position: relative;
            width: var(--hex-width-decorative);
            height: var(--hex-height-decorative);
            background-color: rgba(180, 180, 180, 0.35); 
            clip-path: var(--hex-clip-path); 
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: calc(var(--hex-width-decorative) * -0.1);
            box-sizing: border-box;
        }
        .decorative-hex-grid .grid-cell:last-child { margin-right: 0; }
        .decorative-hex-grid .grid-cell:hover { transform: none; z-index: auto; }
        .decorative-hex-grid .cell-content {
            font-size: calc(var(--hex-width-decorative) * 0.45);
            color: rgba(100, 100, 100, 0.6); 
            font-weight: normal; 
            user-select: none;
            text-align: center;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            max-width: calc(var(--hex-width-decorative) * 0.75);
        }

        #decorative-grid-top-left {
            top: -65px; 
            left: -65px; 
            transform: rotate(-18deg); 
            opacity: 0.55; 
        }
        #decorative-grid-bottom-right {
            bottom: -65px; 
            right: -65px;   
            transform: rotate(18deg);
            opacity: 0.55; 
        }

        /* --- حاوية جديدة لأدوات التحكم السفلية (زر الأسئلة + ألوان الفرق) --- */
        #page-controls-container {
            display: flex;
            flex-direction: column; /* افتراضي للشاشات الصغيرة */
            align-items: center;
            gap: 20px; /* المسافة بين العناصر عند التكديس */
            width: 100%;
            margin-top: 20px; /* مسافة فوق هذه المجموعة */
            margin-bottom: 30px; /* مسافة أسفل هذه المجموعة */
            padding: 0 10px; /* حشوة جانبية صغيرة */
        }


        /* --- Responsive --- */
        @media (min-width: 768px) { /* md breakpoint, أو أي نقطة مناسبة */
            #page-controls-container {
                flex-direction: row; /* ترتيب أفقي للشاشات الأكبر */
                justify-content: center; /* توسيط المجموعة */
                gap: 30px; /* المسافة بين العناصر في الصف */
            }
            .color-controls {
                gap: 20px; /* استعادة الـ gap الأصلي للشاشات الأكبر */
            }
             .color-controls > div {
                flex-direction: row; /* label بجانب input */
                align-items: center;
             }
        }

        @media (max-width: 900px) {
            :root { 
                --hex-width: 50px; 
                --hex-width-decorative: 40px; 
            }
            #game-title-text { max-width: 200px; }
            #title-line-1 { font-size: 3rem; } #title-line-2 { font-size: 2rem; } #title-line-3 { font-size: 3rem; }
            .action-button-style { min-width: 120px; padding: 8px 15px; font-size: 0.9em;} 
            #team-buttons-area { gap: 10px; }
            #team-buttons-area button { min-width: 100px; padding: 7px 14px; font-size: 0.9em;}
            .cell-content { font-size: calc(var(--hex-width) * 0.46); }
            
            #decorative-grid-top-left {
                top: -50px; 
                left: -50px;
                transform: rotate(-18deg); 
            }
            #decorative-grid-bottom-right { 
                bottom: -50px; 
                right: -50px;  
            }
        }
        @media (max-width: 700px) {
            :root { 
                --hex-width: 42px; 
                --hex-width-decorative: 30px; 
            }
            .cell-content { font-size: calc(var(--hex-width) * 0.48); }
            #game-title-text { max-width: 180px; }
            #title-line-1 { font-size: 2.5rem; } #title-line-2 { font-size: 1.8rem; } #title-line-3 { font-size: 2.5rem; }
            .action-button-style { min-width: 120px; padding: 7px 12px; font-size: 0.8em;} 
            #team-buttons-area { gap: 6px; }
            #team-buttons-area button { min-width: 85px; padding: 6px 12px; font-size: 0.8em;}

            #decorative-grid-top-left { 
                top: -35px; 
                left: -35px; 
                transform: rotate(-18deg); 
            }
            #decorative-grid-bottom-right { 
                bottom: -35px; 
                right: -35px;  
            }
        }
        @media (max-width: 550px) {
            body { display: block; padding-top: 15px; }
            :root { 
                --hex-width: 35px; 
                --hex-width-decorative: 25px; 
            }
            .cell-content { font-size: calc(var(--hex-width) * 0.5); }
            .game-layout-row { flex-direction: column; align-items: center; gap: 20px; }
            #game-title-and-buttons { width: 100%; margin-bottom: 20px; gap: 15px; /* ضبط الـ gap هنا أيضاً */ }
            #game-title-text { max-width: 150px; margin: 0 auto; }
            #title-line-1 { font-size: 2rem; } #title-line-2 { font-size: 1.5rem; } #title-line-3 { font-size: 2rem; }
            
            #team-buttons-area {
                position: relative; left: auto; right: auto; top: auto; transform: none;
                width: 95%; max-width: 300px; margin: 0 auto; 
                z-index: 5;
                flex-direction: column; justify-content: center; 
            }
            .action-button-style { 
                 width: auto; /* السماح للزر بأخذ عرض المحتوى + الحشوة */
                 min-width: 120px; /* ضمان حد أدنى للعرض */
                 padding: 8px 15px; /* تعديل الحشوة لتناسب الشاشات الصغيرة */
            } 
            #page-controls-container {
                 gap: 15px; /* تقليل المسافة بين العناصر المكدسة */
            }
            .color-controls > div { /* ضمان أن label فوق input على الشاشات الصغيرة جداً */
                flex-direction: column;
                align-items: center;
            }
            
            #decorative-grid-top-left {
                top: -30px; 
                left: -30px; 
                transform: rotate(-15deg); 
                opacity: 0.5; 
            }
            #decorative-grid-bottom-right {
                bottom: -30px; 
                right: -30px;  
                transform: rotate(15deg);
                opacity: 0.45;
            }
        }
    </style>
</head>
<body>

    <div id="game-content-wrapper">
        <div id="decorative-grid-top-left" class="decorative-hex-grid"></div>
        <div id="decorative-grid-bottom-right" class="decorative-hex-grid"></div>

        <div class="game-layout-row">
            <div id="game-title-and-buttons">
                <div id="game-title-text">
                    <span id="title-line-1">حروف</span>
                    <span id="title-line-2">مع</span>
                    <span id="title-line-3">خبزة</span> 
                </div>
                <div id="team-buttons-area">
                </div>
            </div>
            
            <div id="grid-layout-container">
                <div id="grid-background"></div>
                <div id="hex-grid"> </div>
            </div>
        </div>
        
        <div id="page-controls-container">
            <div id="action-button-area"> <div class="button-with-message-wrapper">
                    <button id="copyAndNavigateButton" class="action-button-style">
                        <i class="far fa-copy"></i>
                        <i class="fas fa-external-link-alt"></i>
                        <span>الأسئلة</span> </button>
                    <span id="copyMessage" class="copy-message">تم النسخ!</span>
                </div>
            </div>

            <div class="color-controls">
                <div>
                    <label for="team1Color">الفريق الأول:</label>
                    <input type="color" id="team1Color" value="#34D399">
                </div>
                <div>
                    <label for="team2Color">الفريق الثاني:</label>
                    <input type="color" id="team2Color" value="#FB923C">
                </div>
            </div>
        </div>
    </div>

    <div id="loading">جاري تحميل البيانات...</div>
    <div id="win-overlay">
        <div class="win-message-text" id="winMessageText"></div>
        <button class="restart-button" id="restartButton">إعادة اللعب</button>
    </div>

    <div id="name-input-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>أدخل اسمك الجديد</h3>
            <input type="text" id="playerNameInput" placeholder="اكتب اسمك هنا">
            <div class="modal-buttons">
                <button id="confirmNameBtn" class="confirm-btn">تأكيد</button>
                <button id="cancelNameBtn" class="cancel-btn">إلغاء</button>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const gridRows = 6; 
        const gridCols = 6; 

        // --- Global State & Constants ---
        let letters = "ابتثجحخدذرزسشصضطظعغفقكلمنهوي"; 
        let currentClickedCellId = null;
        let gameIsOver = false;
        const team1Class = 'answered-team1';
        const team2Class = 'answered-team2';
        const copyTextValue = "0271162329"; 
        const questionsWebsiteUrl = "https://sahamstudio.com/horoof/questions.php"; 
        const DEFAULT_PLAYER_NAME = "خبزة"; 
        const PLAYER_NAME_STORAGE_KEY = "honeycombPlayerName"; 
        let titleAnimationIntervalId = null; 

        // --- DOM Elements ---
        const loadingDiv = document.getElementById('loading');
        const hexGrid = document.getElementById('hex-grid');
        const teamButtonsArea = document.getElementById('team-buttons-area');
        const winOverlay = document.getElementById('win-overlay');
        const winMessageText = document.getElementById('winMessageText');
        const restartButton = document.getElementById('restartButton');
        const gameTitleTextDiv = document.getElementById('game-title-text');
        const titleLine3 = document.getElementById('title-line-3');
        const copyAndNavigateButton = document.getElementById('copyAndNavigateButton');
        const copyMessage = document.getElementById('copyMessage');
        const nameInputModal = document.getElementById('name-input-modal');
        const playerNameInput = document.getElementById('playerNameInput');
        const confirmNameBtn = document.getElementById('confirmNameBtn');
        const cancelNameBtn = document.getElementById('cancelNameBtn');
        const decorativeGridTL = document.getElementById('decorative-grid-top-left');
        const decorativeGridBR = document.getElementById('decorative-grid-bottom-right');

        window.addEventListener('load', initialize);

        function initialize() {
            console.log("Initializing game (Honeycomb Layout, all features)...");
            showLoading(true, "جاري تهيئة اللعبة...");
            hexGrid.innerHTML = ''; 
            hexGrid.style.display = 'none'; 
            teamButtonsArea.style.display = 'none'; 
            winOverlay.classList.remove('visible'); 
            nameInputModal.classList.add('hidden'); 
            gameIsOver = false;

            if (gameTitleTextDiv) {
                gameTitleTextDiv.style.display = 'flex'; 
            }

            loadPlayerName();
            document.querySelectorAll('#game-title-text span').forEach(span => {
                span.addEventListener('dblclick', handleNameChangeDblClick);
            });

            updateGridBackground();
            populateGrid(); 
            
            if (decorativeGridTL) {
                createDecorativeGrid(decorativeGridTL, 5, 5); 
            }
            if (decorativeGridBR) {
                createDecorativeGrid(decorativeGridBR, 5, 5); 
            }

            showLoading(false); 
            startTitleAnimation(); 
            console.log("Grid populated. Decorative grids created and styled. Ready. Title animation started.");
        }

        function startTitleAnimation() {
            if (titleAnimationIntervalId) {
                clearInterval(titleAnimationIntervalId); 
            }
            const titleSpans = [
                document.getElementById('title-line-1'),
                document.getElementById('title-line-2'),
                document.getElementById('title-line-3')
            ];
            const maxOffset = 3; 
            const animationInterval = 250; 

            titleAnimationIntervalId = setInterval(() => {
                titleSpans.forEach(span => {
                    if (span) { 
                        const randomX = (Math.random() * 2 - 1) * maxOffset; 
                        const randomY = (Math.random() * 2 - 1) * maxOffset; 
                        span.style.setProperty('--random-x', `${randomX}px`);
                        span.style.setProperty('--random-y', `${randomY}px`);
                    }
                });
            }, animationInterval);
        }

        function loadPlayerName() {
            const savedName = localStorage.getItem(PLAYER_NAME_STORAGE_KEY);
            titleLine3.innerText = savedName || DEFAULT_PLAYER_NAME;
        }

        function handleNameChangeDblClick() {
            playerNameInput.value = titleLine3.innerText; 
            nameInputModal.classList.remove('hidden'); 
            playerNameInput.focus(); 
        }

        confirmNameBtn.addEventListener('click', () => {
            const newName = playerNameInput.value.trim();
            if (newName !== "") {
                titleLine3.innerText = newName;
                localStorage.setItem(PLAYER_NAME_STORAGE_KEY, newName);
            }
            nameInputModal.classList.add('hidden'); 
        });

        cancelNameBtn.addEventListener('click', () => {
            nameInputModal.classList.add('hidden'); 
        });

        function showLoading(isLoading, message = "جاري التحميل...", isError = false) {
            loadingDiv.innerText = message;
            loadingDiv.style.display = isLoading ? 'block' : 'none';
            loadingDiv.classList.toggle('error-message', isError);
            
            hexGrid.style.display = (!isLoading && !isError) ? 'flex' : 'none'; 
            if (isLoading || isError) {
                teamButtonsArea.style.display = 'none'; 
            }
        }

        function populateGrid() {
            hexGrid.innerHTML = '';
            const shuffledLetters = shuffleArray(letters.split('')); 

            for (let r = 0; r < gridRows; r++) {
                const rowDiv = document.createElement('div');
                rowDiv.classList.add('hex-row');
                for (let c = 0; c < gridCols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.id = `cell-${r}-${c}`;
                    cell.dataset.row = r;
                    cell.dataset.col = c;

                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('cell-content');
                    contentDiv.innerText = shuffledLetters[(r * gridCols + c) % shuffledLetters.length]; 
                    cell.dataset.letter = contentDiv.innerText; 
                    
                    cell.appendChild(contentDiv);
                    cell.addEventListener('click', handleCellClick);
                    rowDiv.appendChild(cell);
                }
                hexGrid.appendChild(rowDiv);
            }
        }

        function createDecorativeGrid(containerElement, numRows, numCols) {
            containerElement.innerHTML = ''; 
            const shuffledLetters = shuffleArray(letters.split('')); 

            for (let r = 0; r < numRows; r++) {
                const rowDiv = document.createElement('div');
                rowDiv.classList.add('hex-row'); 
                for (let c = 0; c < numCols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell'); 
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('cell-content');
                    contentDiv.innerText = shuffledLetters[(r * numCols + c) % shuffledLetters.length];
                    cell.appendChild(contentDiv);
                    rowDiv.appendChild(cell);
                }
                containerElement.appendChild(rowDiv);
            }
        }

        function handleCellClick(event) {
            if (gameIsOver) {
                teamButtonsArea.innerHTML = "";
                return;
            }
            const cell = event.currentTarget;
            currentClickedCellId = cell.id;
            teamButtonsArea.innerHTML = ''; 
            teamButtonsArea.style.display = 'flex'; 

            if (cell.classList.contains(team1Class) || cell.classList.contains(team2Class)) {
                const cancelButton = document.createElement('button');
                cancelButton.className = 'button-cancel';
                cancelButton.innerText = 'إلغاء الإجابة';
                cancelButton.onclick = () => cancelAnswer();
                teamButtonsArea.appendChild(cancelButton);
            } else {
                const btn1 = document.createElement('button');
                btn1.className = 'button-team1';
                btn1.innerText = 'الفريق الأول أجاب';
                btn1.onclick = () => setUserChoice(team1Class);
                const btn2 = document.createElement('button');
                btn2.className = 'button-team2';
                btn2.innerText = 'الفريق الثاني أجاب';
                btn2.onclick = () => setUserChoice(team2Class);
                teamButtonsArea.appendChild(btn1);
                teamButtonsArea.appendChild(btn2);
            }
        }

        function setUserChoice(chosenTeamClass) {
            if (!currentClickedCellId || gameIsOver) return;
            const targetCell = document.getElementById(currentClickedCellId);
            if (targetCell && !targetCell.classList.contains(team1Class) && !targetCell.classList.contains(team2Class)) {
                targetCell.classList.add(chosenTeamClass);
                targetCell.querySelector('.cell-content').style.display = 'none'; 
                checkWinCondition();
                teamButtonsArea.innerHTML = ''; 
                teamButtonsArea.style.display = 'none'; 
            }
            currentClickedCellId = null;
        }

        function cancelAnswer() {
            if (!currentClickedCellId || gameIsOver) return;
            const targetCell = document.getElementById(currentClickedCellId);
            if (targetCell && (targetCell.classList.contains(team1Class) || targetCell.classList.contains(team2Class))) {
                targetCell.classList.remove(team1Class, team2Class);
                targetCell.querySelector('.cell-content').style.display = 'block'; 
                teamButtonsArea.innerHTML = ''; 
                teamButtonsArea.style.display = 'none'; 
            }
            currentClickedCellId = null;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getNeighbors(r, c) {
            const neighbors = [];
            const isEvenRow = (r % 2 === 0); 
            let potentialNeighbors;
            if (isEvenRow) { 
                potentialNeighbors = [[r,c-1],[r,c+1],[r-1,c],[r-1,c-1],[r+1,c],[r+1,c-1]];
            } else { 
                potentialNeighbors = [[r,c-1],[r,c+1],[r-1,c+1],[r-1,c],[r+1,c+1],[r+1,c]];
            }
            potentialNeighbors.forEach(([nr, nc]) => {
                if (nr >= 0 && nr < gridRows && nc >= 0 && nc < gridCols) {
                    const neighborId = `cell-${nr}-${nc}`;
                    if (document.getElementById(neighborId)) { 
                        neighbors.push(neighborId);
                    }
                }
            });
            return neighbors;
        }

        function checkWinCondition() {
            if (checkForPath(team1Class, 'row')) {
                announceWinner("الفريق الأول فاز!", team1Class); return;
            }
            if (checkForPath(team2Class, 'col')) {
                announceWinner("الفريق الثاني فاز!", team2Class); return;
            }
        }

        function checkForPath(teamClass, dimension) {
            const queue = []; const visited = new Set(); let startCells = [];
            if (dimension === 'row') { 
                for (let c_idx = 0; c_idx < gridCols; c_idx++) {
                    const cell = document.getElementById(`cell-0-${c_idx}`); 
                    if (cell && cell.classList.contains(teamClass)) startCells.push(cell);
                }
            } else { 
                for (let r_idx = 0; r_idx < gridRows; r_idx++) {
                    const cell = document.getElementById(`cell-${r_idx}-0`); 
                    if (cell && cell.classList.contains(teamClass)) startCells.push(cell);
                }
            }
            startCells.forEach(cell => { if (!visited.has(cell.id)) { queue.push(cell); visited.add(cell.id); } });
            if (queue.length === 0) return false;
            while (queue.length > 0) {
                const currentCell = queue.shift();
                const r = parseInt(currentCell.dataset.row); const c = parseInt(currentCell.dataset.col);
                if (dimension === 'row' && r === gridRows - 1) return true; 
                if (dimension === 'col' && c === gridCols - 1) return true; 
                const neighbors = getNeighbors(r, c);
                neighbors.forEach(neighborId => {
                    if (!visited.has(neighborId)) {
                        const neighborCell = document.getElementById(neighborId);
                        if (neighborCell && neighborCell.classList.contains(teamClass)) {
                            visited.add(neighborId); queue.push(neighborCell);
                        }
                    }
                });
            }
            return false;
        }

        function announceWinner(winnerText, winnerClass) {
            if (gameIsOver) return;
            gameIsOver = true;
            winMessageText.innerText = `🎉 ${winnerText} 🎉`;
            winOverlay.classList.add('visible'); 
            document.querySelectorAll('.grid-cell:not(.answered-team1):not(.answered-team2)')
                .forEach(cell => { cell.style.opacity = '0.6'; cell.style.cursor = 'not-allowed'; });
            teamButtonsArea.innerHTML = ''; 
            teamButtonsArea.style.display = 'none'; 
        }

        document.getElementById('team1Color').addEventListener('input', (e) => {
            document.documentElement.style.setProperty('--color-team1', e.target.value);
            document.querySelectorAll('.grid-cell.answered-team1').forEach(cell => {
                cell.style.backgroundColor = e.target.value; cell.style.borderColor = e.target.value;
            });
            updateGridBackground(); 
        });
        document.getElementById('team2Color').addEventListener('input', (e) => {
            document.documentElement.style.setProperty('--color-team2', e.target.value);
            document.querySelectorAll('.grid-cell.answered-team2').forEach(cell => {
                cell.style.backgroundColor = e.target.value; cell.style.borderColor = e.target.value;
            });
            updateGridBackground(); 
        });
        
        function updateGridBackground() {
            document.getElementById('grid-background').style.background = `
                conic-gradient(from 45deg at 50% 50%, var(--color-team2) 0deg 90deg, var(--color-team1) 90deg 180deg, var(--color-team2) 180deg 270deg, var(--color-team1) 270deg 360deg)
            `;
        }

        restartButton.addEventListener('click', () => {
            winOverlay.classList.remove('visible'); 
            if (titleAnimationIntervalId) { clearInterval(titleAnimationIntervalId); titleAnimationIntervalId = null; }
            initialize(); 
        });

        copyAndNavigateButton.addEventListener('click', () => {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = copyTextValue;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextArea);
            copyMessage.classList.add('visible');
            setTimeout(() => { copyMessage.classList.remove('visible'); }, 2000); 
            window.open(questionsWebsiteUrl, "_blank");
        });
    </script>
</body>
</html>
