<!DOCTYPE html>
<html dir="rtl">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لعبة حروف</title>
    <link rel="icon" href="https://imgg.io/images/2025/05/23/6fa8fc48102ae5d3f867bf324492dfc0.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* تعريف الخط المخصص محلياً */
        @font-face {
            font-family: 'AA-galaxy';
            src:
                url('./AA-GALAXY.woff2') format('woff2'),
                url('./AA-GALAXY.ttf') format('truetype'),
                url('./AA-GALAXY.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }

        :root {
            /* --- الألوان --- */
            --color-bg: #8B5CF6;
            --color-border-vertical: #34D399; /* Default Team 1 color */
            --color-border-horizontal: #FB923C; /* Default Team 2 color */
            --color-cell-bg: #FFFFFF;
            --color-hex-outer-border: #333;
            --color-cell-text: #000000; 
            --color-team1: var(--color-border-vertical);
            --color-team2: var(--color-border-horizontal);
            --color-text-light: #FFFFFF; 
            --color-text-dark: #333333;
            --color-win-message-bg: rgba(0, 0, 0, 0.75);
            --color-grid-size-button-bg: #f0f0f0;
            --color-grid-size-button-text: #333333;
            --color-grid-size-option-bg: #e9e9e9;
            --color-grid-size-option-hover-bg: #dcdcdc;
            --color-modal-close-button-bg: #6B7280; /* Neutral color for close button */
            --color-modal-close-button-hover-bg: #4B5563;

            /* --- الأبعاد الأساسية للشكل السداسي --- */
            --hex-width: 85px;
            --hex-height: calc(var(--hex-width) * 0.8660254); /* 0.8660254 is approx sqrt(3)/2 */
            --hex-clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);

            /* --- تعديلات التداخل لخلايا النحل المتلاصقة --- */
            --hex-margin-h: calc(var(--hex-width) * -0.134); 
            --hex-margin-v-overlap: calc(var(--hex-height) * -0.25); 
            --hex-stagger-offset: calc(var(--hex-width) * (1 - 0.134*2) / 2); 

            --container-padding: 20px; 

            /* --- أبعاد للخلايا السداسية الزخرفية ولوحة النتائج --- */
            --hex-width-decorative: 55px; 
            --hex-height-decorative: calc(var(--hex-width-decorative) * 0.8660254);
            --score-hex-width: 50px; 
            --score-hex-height: calc(var(--score-hex-width) * 0.8660254);
            --grid-size-hex-width: 60px;
            --grid-size-hex-height: calc(var(--grid-size-hex-width) * 0.8660254);
            
            --grid-size-option-hex-width: 45px; 
            --grid-size-option-hex-height: calc(var(--grid-size-option-hex-width) * 0.8660254);
            --modal-hex-option-margin-h: calc(var(--grid-size-option-hex-width) * -0.134);
            --modal-hex-option-margin-v-overlap: calc(var(--grid-size-option-hex-height) * -0.25);
        }
        *, *::before, *::after { box-sizing: border-box; }

        body {
            font-family: 'AA-galaxy', sans-serif;
            display: flex; justify-content: center; align-items: flex-start; 
            min-height: 100vh; background-color: var(--color-bg); margin: 0; padding: 20px;
            position: relative; overflow-x: hidden; overflow-y: auto;
        }

        #game-content-wrapper {
            display: flex; flex-direction: column; align-items: center;
            position: relative; z-index: 1;
            background-color: #FFFFFF;
            padding: var(--container-padding);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            width: 100%; max-width: 1000px;
            text-align: center;
            overflow: hidden; 
        }

        .game-layout-row { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%;
        }

        #info-panel { 
            order: 1; 
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 20px; 
        }
        
        #header-content-wrapper { 
            display: flex; 
            flex-direction: row;
            align-items: center;
            justify-content: space-around; 
            width: 100%;
            max-width: 400px; 
            margin: 0 auto 15px auto; 
        }

        .score-hex-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .score-hex {
            width: var(--score-hex-width);
            height: var(--score-hex-height);
            clip-path: var(--hex-clip-path);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            color: var(--color-text-light);
            font-weight: bold;
            font-size: calc(var(--score-hex-width) * 0.4);
            transition: transform 0.2s ease, background-color 0.3s ease;
            border: 2px solid rgba(255,255,255,0.5); 
        }
        .score-hex:hover {
            transform: scale(1.1);
        }
        .hidden-color-input { /* Keep this for the native picker, even if triggered differently */
            position: absolute; opacity: 0; width: 0; height: 0; pointer-events: none; top:0; left:0;
        }

        #game-title-text-wrapper { 
            text-align: center;
            margin: 0 5px; 
            flex-shrink: 0; 
        }
        #game-title-text {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; font-family: 'AA-galaxy', sans-serif;
            line-height: 0.9; padding: 5px 0; 
            transform: skewX(-10deg);
        }
        #game-title-text span {
            display: block; font-weight: bold;
            text-shadow: -1px -1px 0 #2c2c2c, 1px -1px 0 #2c2c2c, -1px 1px 0 #2c2c2c, 1px 1px 0 #2c2c2c, 2px 2px 0 #4a4a4a, 3px 3px 0 #6a6a6a;
            white-space: nowrap; padding: 3px 0; cursor: pointer;
            transition: transform 0.2s ease; --random-x: 0px; --random-y: 0px;
            transform: translate(var(--random-x), var(--random-y));
        }
        #game-title-text span:hover { transform: translate(var(--random-x), var(--random-y)) scale(1.05); }
        #title-line-1 { font-size: 3rem; color: #FFD700; }
        #title-line-2 { font-size: 2rem; color: #4FC3F7; }
        #title-line-3 { font-size: 3rem; color: #EF5350; }


        #grid-layout-container {
            order: 2; 
            position: relative; padding: calc(var(--hex-height) * 0.75); width: fit-content;
            margin: 0 auto; border-radius: 15px; overflow: hidden; flex-shrink: 0;
        }
        #grid-background {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: conic-gradient(from 45deg at 50% 50%, var(--color-team2) 0deg 90deg, var(--color-team1) 90deg 180deg, var(--color-team2) 180deg 270deg, var(--color-team1) 270deg 360deg);
            z-index: 0; border-radius: 15px;
        }
        #hex-grid {
            display: flex; flex-direction: column; width: fit-content; position: relative;
            z-index: 1; margin: 0 auto;
        }
        .hex-row { display: flex; margin-bottom: var(--hex-margin-v-overlap); }
        .hex-row:last-child { margin-bottom: 0; }
        .hex-row:nth-child(even) { margin-inline-start: var(--hex-stagger-offset); }

        .grid-cell {
            position: relative; width: var(--hex-width); height: var(--hex-height);
            background-color: var(--color-cell-bg); cursor: pointer; clip-path: var(--hex-clip-path);
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s ease, background-color 0.3s ease, border-color 0.3s ease;
            box-sizing: border-box; margin-right: var(--hex-margin-h);
        }
        .grid-cell:last-child { margin-right: 0; }
        .grid-cell:hover:not(.answered-team1):not(.answered-team2) { 
            transform: scale(1.08); 
            z-index: 5; 
        }
        .cell-content {
            font-size: calc(var(--hex-width) * 0.45); max-width: calc(var(--hex-width) * 0.75);
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            font-weight: bold; user-select: none; text-align: center; 
            color: var(--color-cell-text); 
            font-family: 'AA-galaxy' !important;
            transition: color 0.1s ease-out; 
        }
        .grid-cell.answered-team1, .grid-cell.answered-team2 { cursor: default; }
        .grid-cell.answered-team1:hover, .grid-cell.answered-team2:hover { transform: scale(1); }
        .grid-cell.answered-team1 { background-color: var(--color-team1) !important; border-color: var(--color-team1) !important; }
        .grid-cell.answered-team2 { background-color: var(--color-team2) !important; border-color: var(--color-team2) !important; }
        
        .grid-cell.answered-team1 .cell-content, 
        .grid-cell.answered-team2 .cell-content {
            color: var(--color-text-light) !important; 
            display: none; 
        }

        @keyframes textColorPulse {
            0% { color: var(--color-cell-text); } 
            50% { color: var(--color-text-light); } 
            100% { color: var(--color-cell-text); } 
        }
        .grid-cell .cell-content.selected-text-pulse {
            animation: textColorPulse 1s infinite;
        }

        #team-buttons-area {
            display: flex; flex-direction: column; justify-content: center; gap: 10px; 
            flex-wrap: wrap; min-height: 50px; width: 100%; max-width: 250px; margin-top: 0; 
        }
        #team-buttons-area button {
            padding: 8px 15px; border: none; border-radius: 8px; font-size: 0.9rem; cursor: pointer;
            color: var(--color-text-light); font-weight: bold; transition: background-color 0.3s ease, opacity 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); font-family: 'AA-galaxy', sans-serif;
        }
        #team-buttons-area button:hover { opacity: 0.9; }
        #team-buttons-area .button-team1 { background-color: var(--color-team1); }
        #team-buttons-area .button-team2 { background-color: var(--color-team2); }
        #team-buttons-area .button-cancel { background-color: #EF4444; }
        
        #page-controls-container { 
            display: flex; 
            flex-wrap: wrap; 
            justify-content: center; 
            align-items: center;
            gap: 15px; 
            width: 100%; margin-top: 25px; margin-bottom: 15px; padding: 0 10px; 
        }
        /* Adjusted order for buttons */
        #action-button-area {
            order: 1; /* Questions button group */
            display: flex;
            justify-content: center;
            position: relative;
        }
        #grid-size-control-area { /* Moved to order 2 */
            order: 2; /* Grid size button */
            display: flex; 
            justify-content: center;
            position: relative; 
        }
        #toggleParticipantsButtonWrapper { /* Moved to order 3 */
            order: 3; /* Participants button */
            display: flex;
            justify-content: center;
            position: relative;
        }


        .action-button-style {
            padding: 10px 15px; background-color: #4CAF50; color: white; border: none;
            border-radius: 8px; font-size: 1rem; cursor: pointer; transition: background-color 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: auto; min-width: 130px; font-family: 'AA-galaxy', sans-serif;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .action-button-style:hover { background-color: #45a049; }
        .copy-message {
            font-size: 0.9rem; color: #4CAF50; opacity: 0; transition: opacity 0.3s ease;
            position: absolute; left: 50%; transform: translateX(-50%); bottom: 100%; 
            margin-bottom: 8px; background-color: rgba(0,0,0,0.75);
            padding: 6px 12px; border-radius: 5px; color: white; white-space: nowrap;
            pointer-events: none; font-family: 'AA-galaxy', sans-serif; z-index: 11; 
        }
        .button-with-message-wrapper { position: relative; width: auto; display: inline-block; }
        .copy-message.visible { opacity: 1; }

        /* Grid Size Control Button */
        #grid-size-button {
            width: var(--grid-size-hex-width);
            height: var(--grid-size-hex-height);
            background-color: var(--color-grid-size-button-bg);
            color: var(--color-grid-size-button-text);
            clip-path: var(--hex-clip-path);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: calc(var(--grid-size-hex-width) * 0.35);
            font-weight: bold;
            font-family: 'AA-galaxy', sans-serif;
            cursor: pointer;
            border: 1px solid #ccc;
            transition: background-color 0.3s ease;
        }
        #grid-size-button:hover {
            background-color: #e0e0e0;
        }

        #loading {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 1.3em; text-align: center;
            padding: 15px 25px; color: var(--color-text-light); font-weight: bold; background-color: var(--color-win-message-bg);
            border-radius: 8px; z-index: 30; max-width: 90%; display: block; font-family: 'AA-galaxy', sans-serif;
        }
        #loading.error-message { color: #FFCCCC; background-color: #8B0000; border: 1px solid #FFCCCC; }
        
        #win-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);
            color: white; display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        #win-overlay.visible { opacity: 1; visibility: visible; }
        .win-message-text {
            font-size: 3.5rem; font-weight: bold; margin-bottom: 20px; animation: pulse 1.5s infinite;
            font-family: 'AA-galaxy', sans-serif; text-align: center; padding: 0 10px;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .restart-button {
            padding: 10px 20px; font-size: 1.2rem; background-color: #fff; color: #333;
            border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;
            font-family: 'AA-galaxy', sans-serif;
        }
        .restart-button:hover { background-color: #eee; }

        /* General Modal Styles (reused for name and grid size) */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; visibility: hidden; pointer-events: none; 
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.visible { opacity: 1; visibility: visible; pointer-events: auto; }

        .modal-content {
            background-color: #FFFFFF; padding: 25px; border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); text-align: center; 
            width: 90%; transform: translateY(-20px) scale(0.95); opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            font-family: 'AA-galaxy', sans-serif;
        }
        #name-input-modal .modal-content, #grid-size-modal .modal-content {
             max-width: 280px;
        }
        #color-picker-modal .modal-content {
            max-width: 380px; /* Adjusted for color picker layout */
        }
        /* Styles for the participants iframe container (fixed side panel) */
        #participants-iframe-wrapper {
            position: fixed;
            top: 50%; /* Center vertically */
            left: 50%; /* Center horizontally */
            transform: translate(-50%, -50%) scale(0.8); /* Start smaller and centered */
            width: 350px; /* Square-like width */
            height: 400px; /* Square-like height */
            background-color: transparent; /* Changed to transparent */
            padding: 15px;
            border-radius: 0; /* Changed to 0 */
            box-shadow: none; /* Changed to none */
            z-index: 1000; /* Ensure it's above other game elements */
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
            display: flex; /* Use flex for content alignment */
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Align content to top */
            text-align: center; /* Center text */
            cursor: grab; /* Indicate it's draggable */
            min-width: 200px; /* Minimum size for resizing */
            min-height: 200px; /* Minimum size for resizing */
        }

        #participants-iframe-wrapper.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1); /* Scale up to normal size */
        }

        #participants-iframe-wrapper h3 { /* This h3 is now removed, but keeping for reference if user changes mind */
            font-size: 1.5rem; 
            color: var(--color-text-dark);
            margin-bottom: 15px;
            font-weight: bold;
            width: 100%; 
            padding: 5px 0;
            cursor: grab; 
        }

        #participantsIframe { /* ID change for the iframe */
            width: 100%;
            height: 100%; /* Iframe will take 100% of wrapper's content area */
            border: 2px solid var(--color-team1); /* Keep border on iframe itself for visibility */
            border-radius: 8px;
            margin-bottom: 0; 
        }

        /* Resize Handles */
        .resize-handle {
            position: absolute;
            background: transparent; /* Transparent background */
            border: none; /* No border */
            z-index: 10; /* Above iframe but below parent wrapper */
            opacity: 0; /* Hidden by default */
            transition: opacity 0.2s ease;
        }

        #participants-iframe-wrapper:hover .resize-handle {
            opacity: 1; /* Show handles on hover */
        }
        /* Make handles visible when dragging/resizing */
        #participants-iframe-wrapper.dragging .resize-handle,
        #participants-iframe-wrapper.resizing .resize-handle {
            opacity: 1;
        }


        .resize-handle.n, .resize-handle.s {
            height: 8px;
            left: 10px;
            right: 10px;
            cursor: ns-resize;
        }
        .resize-handle.e, .resize-handle.w {
            width: 8px;
            top: 10px;
            bottom: 10px;
            cursor: ew-resize;
        }
        .resize-handle.nw, .resize-handle.ne, .resize-handle.sw, .resize-handle.se {
            width: 12px;
            height: 12px;
            background: transparent; /* Transparent corners */
            border-radius: 50%;
        }
        /* Visual cue for invisible handles */
        .resize-handle:hover {
            outline: 1px dashed rgba(255, 255, 255, 0.7); /* Subtle dashed border on hover */
        }


        .resize-handle.n { top: 0; }
        .resize-handle.s { bottom: 0; }
        .resize-handle.e { right: 0; }
        .resize-handle.w { left: 0; }
        .resize-handle.nw { top: 0; left: 0; cursor: nwse-resize; }
        .resize-handle.ne { top: 0; right: 0; cursor: nesw-resize; }
        .resize-handle.sw { bottom: 0; left: 0; cursor: nesw-resize; }
        .resize-handle.se { bottom: 0; right: 0; cursor: nwse-resize; }


        .modal-overlay.visible .modal-content { transform: translateY(0) scale(1); opacity: 1;}

        .modal-content h3 { font-size: 1.8rem; color: var(--color-text-dark); margin-bottom: 20px; font-weight: bold; }
        .modal-content input[type="text"] { 
            width: calc(100% - 20px); padding: 12px; margin-bottom: 20px;
            border: 2px solid var(--color-team1); border-radius: 8px; font-size: 1.1rem;
            text-align: center; font-family: 'AA-galaxy', sans-serif; outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }
        .modal-content input[type="text"]:focus { border-color: var(--color-team2); box-shadow: 0 0 0 3px rgba(251, 146, 60, 0.3); }
        
        /* Grid Size Options in Modal - Styled like a hex grid */
        #grid-size-options-modal-content {
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            margin-bottom: 20px;
            padding: 0 5px; 
        }
        .modal-hex-option-row {
            display: flex;
            justify-content: center;
            margin-bottom: var(--modal-hex-option-margin-v-overlap); /* Negative margin for overlap */
        }
        .modal-hex-option-row:last-child {
            margin-bottom: 0;
        }
         .modal-hex-option-row:nth-child(even) {
            /* No stagger for a more grid-like feel in the modal, adjust if honeycomb needed */
        }

        .modal-grid-size-option-btn {
            width: var(--grid-size-option-hex-width);
            height: var(--grid-size-option-hex-height);
            background-color: var(--color-grid-size-option-bg);
            color: var(--color-grid-size-button-text);
            clip-path: var(--hex-clip-path); 
            display: flex; 
            justify-content: center;
            align-items: center;
            font-family: 'AA-galaxy', sans-serif;
            font-size: calc(var(--grid-size-option-hex-width) * 0.4);
            font-weight: bold;
            cursor: pointer;
            border: 1px solid #bbb; 
            transition: background-color 0.2s ease, transform 0.15s ease;
            margin-right: var(--modal-hex-option-margin-h); /* Negative margin for overlap */
        }
        .modal-grid-size-option-btn:last-child { /* Remove margin from last item in a conceptual row */
             margin-right: 0;
        }
        .modal-grid-size-option-btn:hover {
            background-color: var(--color-grid-size-option-hover-bg);
            transform: scale(1.05); 
        }
        .modal-grid-size-option-btn.selected {
            background-color: var(--color-team1);
            color: var(--color-text-light);
            border-color: var(--color-team1);
            transform: scale(1.05);
        }

        .modal-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 10px; }
        .modal-buttons button {
            padding: 10px 25px; border: none; border-radius: 8px; font-size: 1.1rem;
            font-weight: bold; cursor: pointer; transition: background-color 0.3s ease, transform 0.2s ease;
            font-family: 'AA-galaxy', sans-serif; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .modal-buttons button.confirm-btn { background-color: var(--color-team1); color: white; }
        .modal-buttons button.confirm-btn:hover { background-color: #28a77a; transform: translateY(-2px); }
        .modal-buttons button.cancel-btn { background-color: #EF4444; color: white; }
        .modal-buttons button.cancel-btn:hover { background-color: #dc2626; transform: translateY(-2px); }
        .modal-buttons button.neutral-close-btn {
            background-color: var(--color-modal-close-button-bg);
            color: white;
        }
        .modal-buttons button.neutral-close-btn:hover {
            background-color: var(--color-modal-close-button-hover-bg);
            transform: translateY(-2px);
        }


        /* Color Picker Modal Styles */
        #color-picker-swatches-container {
            display: flex;
            justify-content: space-evenly; /* Distribute space for predefined and custom */
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow custom area to wrap below on small screens */
        }
        #predefined-color-swatches-area { /* Container for the two rows of predefined swatches */
            display: flex;
            flex-direction: column;
            align-items: center; /* Center the rows */
            gap: 8px; /* Gap between the two rows */
        }
        .predefined-color-flex-row {
            display: flex;
            justify-content: center;
            gap: 8px; /* Gap between swatches in a row */
        }
        .predefined-color-swatch {
            width: 35px; /* Slightly larger for easier clicking */
            height: 35px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #eee;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .predefined-color-swatch:hover {
            transform: scale(1.1);
            border-color: #ccc;
        }
        #custom-color-swatch-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        #custom-color-preview {
            width: 60px; /* Larger swatch */
            height: 60px;
            border-radius: 8px;
            cursor: pointer;
            border: 3px solid #ccc;
            transition: border-color 0.2s ease;
            background-clip: padding-box; /* Ensures background doesn't go under border */
        }
        #custom-color-preview:hover {
            border-color: #999;
        }
        #custom-color-swatch-area small {
            font-size: 0.8rem;
            color: var(--color-text-dark);
        }


        .decorative-hex-grid { position: absolute; z-index: 0; pointer-events: none; }
        .decorative-hex-grid .hex-row { display: flex; margin-bottom: calc(var(--hex-height-decorative) * -0.2); }
        .decorative-hex-grid .hex-row:nth-child(even) { margin-inline-start: calc(var(--hex-width-decorative) * 0.75 / 2); }
        .decorative-hex-grid .grid-cell {
            position: relative; width: var(--hex-width-decorative); height: var(--hex-height-decorative);
            background-color: rgba(180, 180, 180, 0.35); clip-path: var(--hex-clip-path); 
            display: flex; justify-content: center; align-items: center;
            margin-right: calc(var(--hex-width-decorative) * -0.1); box-sizing: border-box;
        }
        .decorative-hex-grid .grid-cell:last-child { margin-right: 0; }
        .decorative-hex-grid .grid-cell:hover { transform: none; z-index: auto; }
        .decorative-hex-grid .cell-content {
            font-size: calc(var(--hex-width-decorative) * 0.45); color: rgba(100, 100, 100, 0.6); 
            font-weight: normal; user-select: none; text-align: center;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
            max-width: calc(var(--hex-width-decorative) * 0.75);
        }
        #decorative-grid-top-left { top: -65px; left: -65px; transform: rotate(-18deg); opacity: 0.55; }
        #decorative-grid-bottom-right { bottom: -65px; right: -65px; transform: rotate(18deg); opacity: 0.55; }

        /* --- Responsive --- */
        @media (min-width: 768px) { 
            .game-layout-row {
                flex-direction: row; 
                align-items: flex-start; /* Align items to the top in horizontal layout */
                justify-content: center; 
                gap: 10px; 
            }
            #info-panel {
                order: 1; 
                flex-shrink: 0; 
                width: auto; 
                max-width: 280px; 
                margin-bottom: 0; 
                align-items: center; 
                align-self: center; 
            }

            #header-content-wrapper { 
                display: grid; 
                grid-template-areas: 
                    "hex1 hex2"
                    "title title";
                grid-template-columns: auto auto; 
                gap: 10px 15px; 
                justify-items: center; 
                width: 100%; 
                max-width: none; 
                margin-bottom: 15px; 
            }
            #team1-score-hex-wrapper { grid-area: hex1; }
            #team2-score-hex-wrapper { grid-area: hex2; }
            #game-title-text-wrapper { grid-area: title; margin:0; } 

            :root {
                --score-hex-width: 55px; 
                --hex-width: 75px;
                --grid-size-hex-width: 70px;
                --grid-size-option-hex-width: 45px;
            }
            #title-line-1 { font-size: 3.2rem; } 
            #title-line-2 { font-size: 2.2rem; } 
            #title-line-3 { font-size: 3.2rem; }
            .win-message-text { font-size: 4rem; }
            #grid-size-button { font-size: calc(var(--grid-size-hex-width) * 0.4); }

            /* Responsive adjustments for iframe container */
            #participants-iframe-wrapper {
                width: 350px; /* A bit larger */
                height: 400px; /* A bit taller */
            }
        }
        
        @media (max-width: 900px) and (min-width: 768px) { 
             :root {
                --score-hex-width: 50px; 
                --hex-width: 70px;
                --grid-size-hex-width: 65px;
                --grid-size-option-hex-width: 42px;
            }
            #title-line-1 { font-size: 3rem; } 
            #title-line-2 { font-size: 2rem; } 
            #title-line-3 { font-size: 3rem; }
            #participants-iframe-wrapper {
                width: 300px;
                height: 350px;
            }
        }

        @media (max-width: 767.98px) { 
            :root { 
                --hex-width: 50px; 
                --hex-width-decorative: 40px; 
                --score-hex-width: 45px;
                --grid-size-hex-width: 55px;
                --grid-size-option-hex-width: 38px;
            }
            #header-content-wrapper { justify-content: space-around; } 
            #game-title-text-wrapper { flex-grow: 1; text-align: center; }
            #game-title-text { max-width: 180px; margin: 0 auto; } 
            #title-line-1 { font-size: 2.5rem; } #title-line-2 { font-size: 1.7rem; } #title-line-3 { font-size: 2.5rem; }
            .action-button-style { min-width: 120px; padding: 8px 15px; font-size: 0.9em;} 
            #team-buttons-area button { min-width: 100px; padding: 7px 14px; font-size: 0.9em;}
            .cell-content { font-size: calc(var(--hex-width) * 0.46); }
            #decorative-grid-top-left { top: -50px; left: -50px; transform: rotate(-18deg); }
            #decorative-grid-bottom-right { bottom: -50px; right: -50px; }
            .win-message-text { font-size: 2.8rem; }
            #grid-size-button { font-size: calc(var(--grid-size-hex-width) * 0.38); }
            #color-picker-modal .modal-content { max-width: 320px; }

            /* Adjust participants iframe wrapper for smaller screens */
            #participants-iframe-wrapper {
                top: 20px; /* From top */
                left: 50%; /* Center horizontally */
                transform: translateX(-50%) translateY(0); /* Start visible at top center */
                width: 90%; /* Take more width */
                height: 400px; /* Maintain height */
                cursor: grab; /* Still draggable */
            }
            #participants-iframe-wrapper.visible {
                transform: translateX(-50%) translateY(0) scale(1); /* No change in position if visible */
            }
        }
        @media (max-width: 550px) { 
            body { display: block; padding-top: 15px; } 
            :root { 
                --hex-width: 38px; 
                --hex-width-decorative: 25px; 
                --score-hex-width: 38px; 
                --grid-size-hex-width: 50px;
                --grid-size-option-hex-width: 35px;
            }
            #header-content-wrapper { max-width: 320px; justify-content: space-between; } 
            .cell-content { font-size: calc(var(--hex-width) * 0.5); }
            #game-title-text { max-width: 130px; }
            #title-line-1 { font-size: 2rem; } #title-line-2 { font-size: 1.4rem; } #title-line-3 { font-size: 2rem; }
            .action-button-style { min-width: 110px; padding: 7px 12px; font-size: 0.8em;} 
            #team-buttons-area { gap: 6px; max-width: 200px; }
            #team-buttons-area button { min-width: 85px; padding: 6px 12px; font-size: 0.8em;}
            #decorative-grid-top-left { top: -30px; left: -30px; transform: rotate(-15deg); opacity: 0.5; }
            #decorative-grid-bottom-right { bottom: -30px; right: -30px; transform: rotate(15deg); opacity: 0.45; }
            .win-message-text { font-size: 2.2rem; }
            #grid-size-button { font-size: calc(var(--grid-size-hex-width) * 0.4); }
            #color-picker-modal .modal-content { max-width: 90%; } /* Make it more responsive for very small screens */
            .predefined-color-swatch { width: 30px; height: 30px; }
            #custom-color-preview { width: 50px; height: 50px; }

            #participants-iframe-wrapper {
                width: 95%; /* Even more width on very small screens */
                height: 300px; /* Smaller height */
            }
        }
    </style>
</head>
<body>

    <div id="game-content-wrapper">
        <div id="decorative-grid-top-left" class="decorative-hex-grid"></div>
        <div id="decorative-grid-bottom-right" class="decorative-hex-grid"></div>

        <div class="game-layout-row">
            <div id="info-panel">
                <div id="header-content-wrapper">
                    <div id="team1-score-hex-wrapper" class="score-hex-wrapper">
                        <div id="team1-score-hex" class="score-hex" data-team="1">
                            <span id="team1-score" class="score-text">0</span>
                            <input type="color" id="team1ColorHexInput" class="hidden-color-input" value="#34D399">
                        </div>
                    </div>
                    <div id="game-title-text-wrapper">
                        <div id="game-title-text">
                            <span id="title-line-1">حروف</span>
                            <span id="title-line-2">مع</span>
                            <span id="title-line-3">خبزة</span> 
                        </div>
                    </div>
                    <div id="team2-score-hex-wrapper" class="score-hex-wrapper">
                        <div id="team2-score-hex" class="score-hex" data-team="2">
                            <span id="team2-score" class="score-text">0</span>
                            <input type="color" id="team2ColorHexInput" class="hidden-color-input" value="#FB923C">
                        </div>
                    </div>
                </div>
                <div id="team-buttons-area">
                </div>
            </div>
            
            <div id="grid-layout-container">
                <div id="grid-background"></div>
                <div id="hex-grid"> </div>
            </div>
        </div>
        
        <div id="page-controls-container">
            <!-- First button: Questions -->
            <div id="action-button-area"> 
                <div class="button-with-message-wrapper">
                    <button id="questionsButton" class="action-button-style">
                        <i class="far fa-copy"></i>
                        <i class="fas fa-external-link-alt"></i>
                        <span>الأسئلة</span> 
                    </button>
                    <span id="copyMessage" class="copy-message">تم النسخ!</span>
                </div>
            </div>
            <!-- Second button: Grid size control -->
            <div id="grid-size-control-area">
                <div id="grid-size-button" title="تغيير حجم الشبكة">6</div>
            </div>
            <!-- Third button: First to Press (toggle participants) -->
            <div id="toggleParticipantsButtonWrapper">
                <button id="toggleParticipantsButton" class="action-button-style mr-2">
                    <i class="fas fa-hand-pointer"></i> <!-- Changed icon -->
                    <span>اول من يضغط الزر</span> <!-- Changed text -->
                </button>
            </div>
        </div>
    </div>

    <div id="loading">جاري تحميل البيانات...</div>
    <div id="win-overlay">
        <div class="win-message-text" id="winMessageText"></div>
        <button class="restart-button" id="restartButton">إعادة اللعب</button>
    </div>

    <div id="name-input-modal" class="modal-overlay"> 
        <div class="modal-content">
            <h3>أدخل اسمك الجديد</h3>
            <input type="text" id="playerNameInput" placeholder="اكتب اسمك هنا">
            <div class="modal-buttons">
                <button id="confirmNameBtn" class="confirm-btn">تأكيد</button>
                <button id="cancelNameBtn" class="cancel-btn">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="grid-size-modal" class="modal-overlay"> 
        <div class="modal-content">
            <h3>اختر حجم الشبكة</h3>
            <div id="grid-size-options-modal-content">
                </div>
            <div class="modal-buttons">
                <button id="cancelGridSizeBtn" class="cancel-btn">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- New Color Picker Modal -->
    <div id="color-picker-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="color-picker-title">اختر لون الفريق</h3>
            <div id="color-picker-swatches-container">
                <div id="predefined-color-swatches-area">
                    <!-- Predefined swatches will be dynamically added here by JS -->
                </div>
                <div id="custom-color-swatch-area">
                    <div id="custom-color-preview" title="اختيار لون مخصص"></div>
                    <small>لون مخصص</small>
                </div>
            </div>
            <div class="modal-buttons">
                <button id="closeColorPickerBtn" class="confirm-btn">إغلاق</button> 
            </div>
        </div>
    </div>

    <!-- Participants Iframe Wrapper (draggable and resizable) -->
    <div id="participants-iframe-wrapper">
        <!-- Removed h3 title here -->
        <iframe id="participantsIframe" src="https://script.google.com/macros/s/AKfycbzzjpqVDzJAkcNbHrZV7zO-7ncu013YoHteORrdl7Uy64DMmDdyf16E7hjEiw0P5BLX/exec" frameborder="0"></iframe>
        
        <!-- Resize Handles -->
        <div class="resize-handle n"></div>
        <div class="resize-handle s"></div>
        <div class="resize-handle e"></div>
        <div class="resize-handle w"></div>
        <div class="resize-handle nw"></div>
        <div class="resize-handle ne"></div>
        <div class="resize-handle sw"></div>
        <div class="resize-handle se"></div>
    </div>

    <script>
        // --- Configuration ---
        const MIN_GRID_SIZE = 3;
        const MAX_GRID_SIZE = 9; 
        let currentGridSize = 6; 
        let gridRows = currentGridSize; 
        let gridCols = currentGridSize; 

        // --- Global State & Constants ---
        let letters = "ابتثجحخدذرزسشصضطظعغفقكلمنهوي"; 
        let currentClickedCellId = null;
        let gameIsOver = false;
        const team1Class = 'answered-team1';
        const team2Class = 'answered-team2';
        const copyTextValue = "0271162329"; 
        const questionsWebsiteUrl = "https://sahamstudio.com/horoof/questions.php"; 
        const DEFAULT_PLAYER_NAME = "خبزة"; 
        const PLAYER_NAME_STORAGE_KEY = "honeycombPlayerName"; 
        const TEAM1_COLOR_STORAGE_KEY = "honeycombTeam1Color"; // localStorage key for team 1 color
        const TEAM2_COLOR_STORAGE_KEY = "honeycombTeam2Color"; // localStorage key for team 2 color
        let titleAnimationIntervalId = null; 
        let currentlySelectedCellContent = null; 
        let team1Score = 0; 
        let team2Score = 0; 

        const PREDEFINED_COLORS = ['#EF5350', '#FBC02D', '#66BB6A', '#4FC3F7', '#AB47BC', '#FF7043', '#78909C']; // 7 predefined colors
        let currentEditingTeamForColor = null; // 1 or 2

        // --- DOM Elements ---
        const loadingDiv = document.getElementById('loading');
        const hexGrid = document.getElementById('hex-grid');
        const teamButtonsArea = document.getElementById('team-buttons-area');
        const winOverlay = document.getElementById('win-overlay');
        const winMessageText = document.getElementById('winMessageText');
        const restartButton = document.getElementById('restartButton');
        const titleLine3 = document.getElementById('title-line-3');
        const questionsButton = document.getElementById('questionsButton'); 
        const copyMessage = document.getElementById('copyMessage');
        
        const nameInputModal = document.getElementById('name-input-modal');
        const playerNameInput = document.getElementById('playerNameInput');
        const confirmNameBtn = document.getElementById('confirmNameBtn');
        const cancelNameBtn = document.getElementById('cancelNameBtn');
        
        const gridSizeModal = document.getElementById('grid-size-modal');
        const gridSizeOptionsModalContent = document.getElementById('grid-size-options-modal-content');
        const cancelGridSizeBtn = document.getElementById('cancelGridSizeBtn');
        const gridSizeButton = document.getElementById('grid-size-button'); 

        const decorativeGridTL = document.getElementById('decorative-grid-top-left');
        const decorativeGridBR = document.getElementById('decorative-grid-bottom-right');

        const team1ScoreHex = document.getElementById('team1-score-hex');
        const team2ScoreHex = document.getElementById('team2-score-hex');
        const team1ScoreDisplay = document.getElementById('team1-score');
        const team2ScoreDisplay = document.getElementById('team2-score');
        const team1ColorHexInput = document.getElementById('team1ColorHexInput');
        const team2ColorHexInput = document.getElementById('team2ColorHexInput');

        // Color Picker Modal Elements
        const colorPickerModal = document.getElementById('color-picker-modal');
        const colorPickerTitle = document.getElementById('color-picker-title');
        const predefinedSwatchesArea = document.getElementById('predefined-color-swatches-area');
        const customColorPreview = document.getElementById('custom-color-preview');
        const closeColorPickerBtn = document.getElementById('closeColorPickerBtn');

        // Participants Iframe Elements
        const participantsIframeWrapper = document.getElementById('participants-iframe-wrapper'); 
        const participantsIframe = document.getElementById('participantsIframe'); 
        const toggleParticipantsButton = document.getElementById('toggleParticipantsButton'); 
        // participantsIframeTitle is removed, so no direct reference needed for element, but logic for drag will move to wrapper.

        // Draggable State Variables
        let isDragging = false;
        let dragInitialMouseX, dragInitialMouseY;
        let dragInitialWrapperX, dragInitialWrapperY; // Store actual pixel position of wrapper

        // Resizable State Variables
        let isResizing = false;
        let resizeHandleType = ''; // 'n', 's', 'e', 'w', 'nw', 'ne', 'sw', 'se'
        let resizeInitialMouseX, resizeInitialMouseY;
        let resizeInitialWrapperWidth, resizeInitialWrapperHeight;
        let resizeInitialWrapperX, resizeInitialWrapperY; // Store actual pixel position of wrapper

        // Min dimensions for resizable window
        const MIN_IFRAME_WIDTH = 250; // px
        const MIN_IFRAME_HEIGHT = 300; // px

        // Constant for participants iframe URL
        const PARTICIPANTS_IFRAME_URL = "https://script.google.com/macros/s/AKfycbzzjpqVDzJAkcNbHrZV7zO-7ncu013YoHteORrdl7Uy64DMmDdyf16E7hjEiw0P5BLX/exec";


        window.addEventListener('load', initialize);

        function initialize() {
            console.log("Initializing game with grid size:", currentGridSize);
            showLoading(true, "جاري تهيئة اللعبة...");

            gridRows = currentGridSize;
            gridCols = currentGridSize;

            if(gridSizeButton) gridSizeButton.textContent = currentGridSize;
            
            if(hexGrid) {
                hexGrid.innerHTML = ''; 
                hexGrid.style.display = 'none'; 
            }
            if(teamButtonsArea) teamButtonsArea.style.display = 'none'; 
            if(winOverlay) winOverlay.classList.remove('visible'); 
            if(nameInputModal) nameInputModal.classList.remove('visible'); 
            if(gridSizeModal) gridSizeModal.classList.remove('visible'); 
            if(colorPickerModal) colorPickerModal.classList.remove('visible');
            if(participantsIframeWrapper) participantsIframeWrapper.classList.remove('visible'); // Hide iframe on init
            gameIsOver = false;
            
            updateScoreDisplay(); 
            
            const rootStyles = getComputedStyle(document.documentElement);
            // Load colors from localStorage or use defaults
            let initialTeam1Color = localStorage.getItem(TEAM1_COLOR_STORAGE_KEY) || rootStyles.getPropertyValue('--color-border-vertical').trim();
            let initialTeam2Color = localStorage.getItem(TEAM2_COLOR_STORAGE_KEY) || rootStyles.getPropertyValue('--color-border-horizontal').trim();
            
            team1ColorHexInput.value = initialTeam1Color;
            team2ColorHexInput.value = initialTeam2Color;

            applyTeamColorChange(1, initialTeam1Color, true); 
            applyTeamColorChange(2, initialTeam2Color, true); 


            if (currentlySelectedCellContent) {
                currentlySelectedCellContent.classList.remove('selected-text-pulse');
            }
            currentlySelectedCellContent = null; 

            const gameTitleTextDiv = document.getElementById('game-title-text');
            if (gameTitleTextDiv) { 
                gameTitleTextDiv.style.display = 'flex'; 
            }

            loadPlayerName();
            document.querySelectorAll('#game-title-text span').forEach(span => {
                span.addEventListener('dblclick', handleNameChangeDblClick);
            });

            populateGrid(); 
            
            if (decorativeGridTL) {
                createDecorativeGrid(decorativeGridTL, 5, 5); 
            }
            if (decorativeGridBR) {
                createDecorativeGrid(decorativeGridBR, 5, 5); 
            }
            
            setupColorPickers(); 
            setupGridSizeControls(); 
            setupIframeControls(); // Setup iframe controls
            setupIframeResizeHandles(); // Setup resize handles

            showLoading(false); 
            startTitleAnimation(); 
            console.log("Initialization complete.");
        }

        function createGridSizeOptionsInModal() {
            if (!gridSizeOptionsModalContent) return;
            gridSizeOptionsModalContent.innerHTML = ''; 
            
            let currentRow = null;
            const itemsPerRow = 3; 

            for (let i = MIN_GRID_SIZE; i <= MAX_GRID_SIZE; i++) {
                if ((i - MIN_GRID_SIZE) % itemsPerRow === 0) {
                    currentRow = document.createElement('div');
                    currentRow.classList.add('modal-hex-option-row');
                    gridSizeOptionsModalContent.appendChild(currentRow);
                }

                const optionBtn = document.createElement('button');
                optionBtn.classList.add('modal-grid-size-option-btn');
                optionBtn.textContent = i;
                if (i === currentGridSize) {
                    optionBtn.classList.add('selected');
                    optionBtn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-team1').trim();
                    optionBtn.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--color-team1').trim();
                    optionBtn.style.color = 'var(--color-text-light)';
                }
                optionBtn.addEventListener('click', () => {
                    currentGridSize = i;
                    if(gridSizeButton) gridSizeButton.textContent = currentGridSize;
                    
                    if(gridSizeModal) gridSizeModal.classList.remove('visible'); 
                    
                    initialize(); 
                });
                if(currentRow) currentRow.appendChild(optionBtn); 
            }
        }

        function setupGridSizeControls() {
            if (gridSizeButton && gridSizeModal) {
                gridSizeButton.addEventListener('click', () => {
                    createGridSizeOptionsInModal(); 
                    gridSizeModal.classList.add('visible');
                });
            }
            if(cancelGridSizeBtn && gridSizeModal) {
                cancelGridSizeBtn.addEventListener('click', () => {
                    gridSizeModal.classList.remove('visible');
                });
            }
        }
        
        function updateScoreDisplay() {
            if (team1ScoreDisplay) team1ScoreDisplay.innerText = String(team1Score);
            if (team2ScoreDisplay) team2ScoreDisplay.innerText = String(team2Score);
        }

        function setupColorPickers() {
            if (team1ScoreHex) team1ScoreHex.addEventListener('click', () => openColorPickerModal(1));
            if (team2ScoreHex) team2ScoreHex.addEventListener('click', () => openColorPickerModal(2));

            if (team1ColorHexInput) team1ColorHexInput.addEventListener('input', (e) => {
                if (currentEditingTeamForColor === 1) {
                    const newColor = e.target.value;
                    applyTeamColorChange(1, newColor);
                    if (customColorPreview) customColorPreview.style.backgroundColor = newColor;
                }
            });

            if (team2ColorHexInput) team2ColorHexInput.addEventListener('input', (e) => {
                if (currentEditingTeamForColor === 2) {
                    const newColor = e.target.value;
                    applyTeamColorChange(2, newColor);
                    if (customColorPreview) customColorPreview.style.backgroundColor = newColor;
                }
            });

            if(closeColorPickerBtn && colorPickerModal) {
                closeColorPickerBtn.addEventListener('click', () => {
                    colorPickerModal.classList.remove('visible');
                    currentEditingTeamForColor = null;
                });
            }
        }

        function openColorPickerModal(teamNumber) {
            if (!colorPickerModal || !predefinedSwatchesArea || !customColorPreview || !team1ColorHexInput || !team2ColorHexInput || !colorPickerTitle) {
                console.error("Color picker modal elements not found");
                return;
            }

            currentEditingTeamForColor = teamNumber;
            const currentInput = (teamNumber === 1) ? team1ColorHexInput : team2ColorHexInput;
            const currentColor = currentInput.value;
            const teamColorVar = teamNumber === 1 ? '--color-team1' : '--color-team2';

            colorPickerTitle.textContent = `اختر لون الفريق ${teamNumber}`;

            predefinedSwatchesArea.innerHTML = ''; 
            
            const predefinedRow1 = document.createElement('div');
            predefinedRow1.classList.add('predefined-color-flex-row');
            const predefinedRow2 = document.createElement('div');
            predefinedRow2.classList.add('predefined-color-flex-row');

            PREDEFINED_COLORS.forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.classList.add('predefined-color-swatch');
                swatch.style.backgroundColor = color;
                swatch.dataset.color = color;
                swatch.title = color; 
                swatch.addEventListener('click', () => {
                    applyTeamColorChange(teamNumber, color);
                    customColorPreview.style.backgroundColor = color;
                    currentInput.value = color; 
                });
                if (index < 4) {
                    predefinedRow1.appendChild(swatch);
                } else {
                    predefinedRow2.appendChild(swatch);
                }
            });
            predefinedSwatchesArea.appendChild(predefinedRow1);
            predefinedSwatchesArea.appendChild(predefinedRow2);
            
            customColorPreview.style.backgroundColor = currentColor;
            customColorPreview.onclick = () => { 
                if (currentEditingTeamForColor === 1) team1ColorHexInput.click();
                else if (currentEditingTeamForColor === 2) team2ColorHexInput.click();
            };
            
            if (closeColorPickerBtn) {
                 closeColorPickerBtn.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue(teamColorVar).trim();
            }

            colorPickerModal.classList.add('visible');
        }

        function applyTeamColorChange(teamNumber, newColor, isInitialSetup = false) {
            const teamVar = `--color-team${teamNumber}`;
            const scoreHexEl = (teamNumber === 1) ? team1ScoreHex : team2ScoreHex;
            const inputElement = (teamNumber === 1) ? team1ColorHexInput : team2ColorHexInput;
            const answeredCellClass = (teamNumber === 1) ? team1Class : team2Class;
            const teamButtonSelector = `.button-team${teamNumber}`;
            const storageKey = (teamNumber === 1) ? TEAM1_COLOR_STORAGE_KEY : TEAM2_COLOR_STORAGE_KEY;

            document.documentElement.style.setProperty(teamVar, newColor);
            if (scoreHexEl) scoreHexEl.style.backgroundColor = newColor;
            if (inputElement && inputElement.value !== newColor) {
                 inputElement.value = newColor;
            }
            document.querySelectorAll(`.grid-cell.${answeredCellClass}`).forEach(cell => {
                cell.style.backgroundColor = newColor;
                cell.style.borderColor = newColor;
            });
            const teamButton = teamButtonsArea ? teamButtonsArea.querySelector(teamButtonSelector) : null;
            if (teamButton) teamButton.style.backgroundColor = newColor;
            updateGridBackground();
            const selectedGridSizeOption = gridSizeOptionsModalContent ? gridSizeOptionsModalContent.querySelector('.modal-grid-size-option-btn.selected') : null;
            if (selectedGridSizeOption && teamNumber === 1) { 
                selectedGridSizeOption.style.backgroundColor = newColor;
                selectedGridSizeOption.style.borderColor = newColor;
            }
            if (confirmNameBtn && teamNumber === 1) { 
                 confirmNameBtn.style.backgroundColor = newColor;
            }
            if (!isInitialSetup && colorPickerModal && colorPickerModal.classList.contains('visible') && currentEditingTeamForColor === teamNumber) {
                if (closeColorPickerBtn) {
                    closeColorPickerBtn.style.backgroundColor = newColor;
                }
            }
            // Save to localStorage if not initial setup
            if (!isInitialSetup) {
                localStorage.setItem(storageKey, newColor);
            }
        }


        function startTitleAnimation() {
            if (titleAnimationIntervalId) {
                clearInterval(titleAnimationIntervalId); 
            }
            const titleSpans = [
                document.getElementById('title-line-1'),
                document.getElementById('title-line-2'),
                document.getElementById('title-line-3')
            ];
            const maxOffset = 3; 
            const animationInterval = 250; 

            titleAnimationIntervalId = setInterval(() => {
                titleSpans.forEach(span => {
                    if (span) { 
                        const randomX = (Math.random() * 2 - 1) * maxOffset; 
                        const randomY = (Math.random() * 2 - 1) * maxOffset; 
                        span.style.setProperty('--random-x', `${randomX}px`);
                        span.style.setProperty('--random-y', `${randomY}px`);
                    }
                });
            }, animationInterval);
        }

        function loadPlayerName() {
            const savedName = localStorage.getItem(PLAYER_NAME_STORAGE_KEY);
            if(titleLine3) titleLine3.innerText = savedName || DEFAULT_PLAYER_NAME;
        }

        function handleNameChangeDblClick() {
            if(playerNameInput && titleLine3) playerNameInput.value = titleLine3.innerText; 
            if(nameInputModal) nameInputModal.classList.add('visible'); 
            if(playerNameInput) playerNameInput.focus(); 
        }

        if(confirmNameBtn) confirmNameBtn.addEventListener('click', () => {
            const newName = playerNameInput ? playerNameInput.value.trim() : "";
            if (newName !== "") {
                if(titleLine3) titleLine3.innerText = newName;
                localStorage.setItem(PLAYER_NAME_STORAGE_KEY, newName);
            }
            if(nameInputModal) nameInputModal.classList.remove('visible'); 
        });

        if(cancelNameBtn) cancelNameBtn.addEventListener('click', () => {
            if(nameInputModal) nameInputModal.classList.remove('visible'); 
        });

        function showLoading(isLoading, message = "جاري التحميل...", isError = false) {
            if(loadingDiv) {
                loadingDiv.innerText = message;
                loadingDiv.style.display = isLoading ? 'block' : 'none';
                loadingDiv.classList.toggle('error-message', isError);
            }
            
            if(hexGrid) hexGrid.style.display = (!isLoading && !isError) ? 'flex' : 'none'; 
            if (teamButtonsArea && (isLoading || isError)) {
                teamButtonsArea.style.display = 'none'; 
            }
        }

        function populateGrid() {
            if(!hexGrid) return;
            hexGrid.innerHTML = '';
            let currentLetters = letters.split('');
            const requiredLetters = gridRows * gridCols;
            let displayLetters = [];
            for(let i = 0; i < requiredLetters; i++) {
                displayLetters.push(currentLetters[i % currentLetters.length]);
            }
            const shuffledLetters = shuffleArray(displayLetters); 


            for (let r = 0; r < gridRows; r++) {
                const rowDiv = document.createElement('div');
                rowDiv.classList.add('hex-row');
                for (let c = 0; c < gridCols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.id = `cell-${r}-${c}`;
                    cell.dataset.row = r;
                    cell.dataset.col = c;

                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('cell-content');
                    contentDiv.innerText = shuffledLetters[r * gridCols + c];
                    cell.dataset.letter = contentDiv.innerText; 
                    
                    cell.appendChild(contentDiv);
                    cell.addEventListener('click', handleCellClick);
                    rowDiv.appendChild(cell);
                }
                hexGrid.appendChild(rowDiv);
            }
        }

        function createDecorativeGrid(containerElement, numRows, numCols) {
            if(!containerElement) return;
            containerElement.innerHTML = ''; 
            const shuffledLetters = shuffleArray(letters.split('')); 

            for (let r = 0; r < numRows; r++) {
                const rowDiv = document.createElement('div');
                rowDiv.classList.add('hex-row'); 
                for (let c = 0; c < numCols; c++) {
                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell'); 
                    const contentDiv = document.createElement('div');
                    contentDiv.classList.add('cell-content');
                    contentDiv.innerText = shuffledLetters[(r * numCols + c) % shuffledLetters.length];
                    cell.appendChild(contentDiv);
                    rowDiv.appendChild(cell);
                }
                containerElement.appendChild(rowDiv);
            }
        }

        function handleCellClick(event) {
            if (gameIsOver) {
                if(teamButtonsArea) teamButtonsArea.innerHTML = "";
                return;
            }
            const cell = event.currentTarget;
            const cellContent = cell.querySelector('.cell-content');
            currentClickedCellId = cell.id; 

            if (currentlySelectedCellContent && currentlySelectedCellContent !== cellContent) {
                currentlySelectedCellContent.classList.remove('selected-text-pulse');
            }
            
            if(!teamButtonsArea) return;
            teamButtonsArea.innerHTML = ''; 
            teamButtonsArea.style.display = 'flex';

            if (cell.classList.contains(team1Class) || cell.classList.contains(team2Class)) {
                if (currentlySelectedCellContent === cellContent && cellContent) { 
                    cellContent.classList.remove('selected-text-pulse');
                }
                currentlySelectedCellContent = null; 

                const cancelButton = document.createElement('button');
                cancelButton.className = 'button-cancel';
                cancelButton.innerText = 'إلغاء الإجابة';
                cancelButton.onclick = () => cancelAnswer();
                teamButtonsArea.appendChild(cancelButton);

            } else {
                if (currentlySelectedCellContent === cellContent && cellContent) {
                    cellContent.classList.remove('selected-text-pulse');
                    currentlySelectedCellContent = null;
                    teamButtonsArea.innerHTML = ''; 
                    teamButtonsArea.style.display = 'none';
                    currentClickedCellId = null; 
                    return; 
                } else {
                    if (cellContent) cellContent.classList.add('selected-text-pulse'); 
                    currentlySelectedCellContent = cellContent;

                    const btn1 = document.createElement('button');
                    btn1.className = 'button-team1';
                    btn1.innerText = 'الفريق الأول أجاب';
                    btn1.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-team1').trim();
                    btn1.onclick = () => setUserChoice(team1Class);
                    const btn2 = document.createElement('button');
                    btn2.className = 'button-team2';
                    btn2.innerText = 'الفريق الثاني أجاب';
                    btn2.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--color-team2').trim();
                    btn2.onclick = () => setUserChoice(team2Class);
                    teamButtonsArea.appendChild(btn1);
                    teamButtonsArea.appendChild(btn2);
                }
            }
        }

        function setUserChoice(chosenTeamClass) {
            if (!currentClickedCellId || gameIsOver) return;
            const targetCell = document.getElementById(currentClickedCellId);
            const targetCellContent = targetCell ? targetCell.querySelector('.cell-content') : null;

            if (targetCellContent && currentlySelectedCellContent === targetCellContent) {
                targetCellContent.classList.remove('selected-text-pulse');
                currentlySelectedCellContent = null; 
            }

            if (targetCell && !targetCell.classList.contains(team1Class) && !targetCell.classList.contains(team2Class)) {
                targetCell.classList.add(chosenTeamClass);
                if (targetCellContent) targetCellContent.style.display = 'none'; 
                checkWinCondition(); 
                if(teamButtonsArea) {
                    teamButtonsArea.innerHTML = ''; 
                    teamButtonsArea.style.display = 'none'; 
                }
            }
            currentClickedCellId = null;
        }

        function cancelAnswer() {
            if (!currentClickedCellId || gameIsOver) return;
            const targetCell = document.getElementById(currentClickedCellId);
            const targetCellContent = targetCell ? targetCell.querySelector('.cell-content') : null;

            if (targetCellContent && currentlySelectedCellContent === targetCellContent) {
                targetCellContent.classList.remove('selected-text-pulse');
                currentlySelectedCellContent = null;
            }
            
            if (targetCell && (targetCell.classList.contains(team1Class) || targetCell.classList.contains(team2Class))) {
                targetCell.classList.remove(team1Class, team2Class);
                if (targetCellContent) targetCellContent.style.display = 'block'; 
                if(teamButtonsArea) {
                    teamButtonsArea.innerHTML = ''; 
                    teamButtonsArea.style.display = 'none'; 
                }
            }
            currentClickedCellId = null;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function getNeighbors(r, c) {
            const neighbors = [];
            const isEvenRow = (r % 2 === 0); 
            let potentialNeighbors;
            if (isEvenRow) { 
                potentialNeighbors = [
                    [r, c - 1], [r, c + 1], [r - 1, c], [r - 1, c - 1], [r + 1, c], [r + 1, c - 1]
                ];
            } else { 
                potentialNeighbors = [
                    [r, c - 1], [r, c + 1], [r - 1, c + 1], [r - 1, c], [r + 1, c + 1], [r + 1, c]
                ];
            }
            potentialNeighbors.forEach(([nr, nc]) => {
                if (nr >= 0 && nr < gridRows && nc >= 0 && nc < gridCols) { 
                    const neighborId = `cell-${nr}-${nc}`;
                    if (document.getElementById(neighborId)) { 
                        neighbors.push(neighborId);
                    }
                }
            });
            return neighbors;
        }

        function checkWinCondition() {
            if (checkForPath(team1Class, 'row')) { 
                team1Score++; 
                updateScoreDisplay(); 
                announceWinner("الفريق الأول فاز!", team1Class); return;
            }
            if (checkForPath(team2Class, 'col')) { 
                team2Score++; 
                updateScoreDisplay(); 
                announceWinner("الفريق الثاني فاز!", team2Class); return;
            }
        }

        function checkForPath(teamClass, dimension) {
            const queue = []; 
            const visited = new Set(); 
            let startCells = [];

            if (dimension === 'row') { 
                for (let c_idx = 0; c_idx < gridCols; c_idx++) { 
                    const cell = document.getElementById(`cell-0-${c_idx}`); 
                    if (cell && cell.classList.contains(teamClass)) startCells.push(cell);
                }
            } else { 
                for (let r_idx = 0; r_idx < gridRows; r_idx++) { 
                    const cell = document.getElementById(`cell-${r_idx}-0`); 
                    if (cell && cell.classList.contains(teamClass)) startCells.push(cell);
                }
            }

            startCells.forEach(cell => { if (cell && !visited.has(cell.id)) { queue.push(cell); visited.add(cell.id); } });
            
            if (queue.length === 0) return false;

            while (queue.length > 0) {
                const currentCell = queue.shift();
                if(!currentCell) continue; 
                const r = parseInt(currentCell.dataset.row); 
                const c = parseInt(currentCell.dataset.col);

                if (dimension === 'row' && r === gridRows - 1) return true; 
                if (dimension === 'col' && c === gridCols - 1) return true; 
                
                const neighbors = getNeighbors(r, c);
                neighbors.forEach(neighborId => {
                    if (!visited.has(neighborId)) {
                        const neighborCell = document.getElementById(neighborId);
                        if (neighborCell && neighborCell.classList.contains(teamClass)) {
                            visited.add(neighborId); queue.push(neighborCell);
                        }
                    }
                });
            }
            return false;
        }

        function announceWinner(winnerText, winnerClass) {
            if (gameIsOver) return;
            gameIsOver = true;

            if (currentlySelectedCellContent) { 
                currentlySelectedCellContent.classList.remove('selected-text-pulse');
                currentlySelectedCellContent = null;
            }

            if(winMessageText) winMessageText.innerText = `🎉 ${winnerText} 🎉`;
            if(winOverlay) winOverlay.classList.add('visible'); 
            document.querySelectorAll('.grid-cell:not(.answered-team1):not(.answered-team2)')
                .forEach(cell => { cell.style.opacity = '0.6'; cell.style.cursor = 'not-allowed'; });
            if(teamButtonsArea) {
                teamButtonsArea.innerHTML = ''; 
                teamButtonsArea.style.display = 'none'; 
            }
        }
        
        function updateGridBackground() {
            const gridBg = document.getElementById('grid-background');
            if(gridBg) {
                const colorTeam1 = getComputedStyle(document.documentElement).getPropertyValue('--color-team1').trim();
                const colorTeam2 = getComputedStyle(document.documentElement).getPropertyValue('--color-team2').trim();
                gridBg.style.background = `
                    conic-gradient(from 45deg at 50% 50%, ${colorTeam2} 0deg 90deg, ${colorTeam1} 90deg 180deg, ${colorTeam2} 180deg 270deg, ${colorTeam1} 270deg 360deg)
                `;
            }
        }

        if(restartButton) restartButton.addEventListener('click', () => {
            if(winOverlay) winOverlay.classList.remove('visible'); 
            if (titleAnimationIntervalId) { clearInterval(titleAnimationIntervalId); titleAnimationIntervalId = null; }
            initialize(); 
        });

        if(questionsButton) questionsButton.addEventListener('click', () => {
            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = copyTextValue;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            try {
                 document.execCommand('copy');
                 if(copyMessage) copyMessage.classList.add('visible');
                 setTimeout(() => { if(copyMessage) copyMessage.classList.remove('visible'); }, 2000); 
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(tempTextArea);
            window.open(questionsWebsiteUrl, "_blank");
        });

        // --- Iframe Controls (fixed draggable and resizable modal) ---
        function setupIframeControls() {
            if (toggleParticipantsButton && participantsIframeWrapper) {
                toggleParticipantsButton.addEventListener('click', () => {
                    participantsIframeWrapper.classList.toggle('visible');
                    // Reset position if showing for the first time or if it was off-screen
                    if (participantsIframeWrapper.classList.contains('visible')) {
                        // Set initial position to center of screen relative to viewport
                        const viewportWidth = window.innerWidth;
                        const viewportHeight = window.innerHeight;
                        const wrapperWidth = participantsIframeWrapper.offsetWidth;
                        const wrapperHeight = participantsIframeWrapper.offsetHeight;

                        participantsIframeWrapper.style.left = ((viewportWidth - wrapperWidth) / 2) + 'px';
                        participantsIframeWrapper.style.top = ((viewportHeight - wrapperHeight) / 2) + 'px';
                        participantsIframeWrapper.style.transform = 'none'; // Crucial: remove transform for direct positioning

                        // Also trigger the share link action
                        shareParticipantsLink();
                    }
                });
            }

            // Draggable functionality
            // Now, the entire participantsIframeWrapper is draggable
            if (participantsIframeWrapper) { 
                participantsIframeWrapper.addEventListener('mousedown', (e) => {
                    // Only start dragging if not on a resize handle
                    if (e.target.classList.contains('resize-handle')) {
                        return; 
                    }
                    isDragging = true;
                    participantsIframeWrapper.classList.add('dragging'); // Add dragging class for visual cue
                    
                    const rect = participantsIframeWrapper.getBoundingClientRect();
                    dragInitialMouseX = e.clientX;
                    dragInitialMouseY = e.clientY;
                    dragInitialWrapperX = rect.left;
                    dragInitialWrapperY = rect.top;

                    // Temporarily disable pointer events on iframe to allow mousemove on wrapper
                    participantsIframe.style.pointerEvents = 'none';

                    document.addEventListener('mousemove', onDragMouseMove);
                    document.addEventListener('mouseup', onDragOrResizeMouseUp); // Use a single mouseup handler
                    e.preventDefault();
                });
            }

            function onDragMouseMove(e) {
                if (!isDragging) return;

                let newLeft = dragInitialWrapperX + (e.clientX - dragInitialMouseX);
                let newTop = dragInitialWrapperY + (e.clientY - dragInitialMouseY);

                // Keep within viewport boundaries
                newLeft = Math.max(0, Math.min(newLeft, window.innerWidth - participantsIframeWrapper.offsetWidth));
                newTop = Math.max(0, Math.min(newTop, window.innerHeight - participantsIframeWrapper.offsetHeight));

                participantsIframeWrapper.style.left = newLeft + 'px';
                participantsIframeWrapper.style.top = newTop + 'px';
                participantsIframeWrapper.style.transform = 'none'; // Ensure transform is off during direct positioning
            }

            // Consolidated mouseup handler for both drag and resize
            function onDragOrResizeMouseUp() {
                isDragging = false;
                isResizing = false;
                participantsIframeWrapper.classList.remove('dragging', 'resizing'); // Remove dragging/resizing classes
                participantsIframe.style.pointerEvents = 'auto'; // Re-enable pointer events for iframe
                document.removeEventListener('mousemove', onDragMouseMove); // Remove specific dragging listener
                document.removeEventListener('mousemove', onResizeMouseMove); // Remove specific resizing listener
                document.removeEventListener('mouseup', onDragOrResizeMouseUp);
            }
        }

        // --- Iframe Resizable Controls ---
        function setupIframeResizeHandles() {
            const handles = document.querySelectorAll('#participants-iframe-wrapper .resize-handle'); // Select handles specifically within the wrapper
            handles.forEach(handle => {
                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    participantsIframeWrapper.classList.add('resizing'); // Add resizing class for visual cue
                    resizeHandleType = e.target.classList[1]; // e.g., 'n', 'se'
                    
                    const rect = participantsIframeWrapper.getBoundingClientRect();
                    initialWidth = rect.width;
                    initialHeight = rect.height;
                    resizeInitialMouseX = e.clientX; // Store initial mouse position for calculating delta
                    resizeInitialMouseY = e.clientY;
                    
                    // Capture initial iframe position to adjust when resizing from top/left
                    resizeInitialWrapperX = rect.left;
                    resizeInitialWrapperY = rect.top;

                    participantsIframe.style.pointerEvents = 'none'; // Disable iframe events during resize
                    document.addEventListener('mousemove', onResizeMouseMove);
                    document.addEventListener('mouseup', onDragOrResizeMouseUp);
                    e.preventDefault(); // Prevent text selection etc.
                });
            });

            function onResizeMouseMove(e) {
                if (!isResizing) return;

                let newWidth = initialWidth;
                let newHeight = initialHeight;
                let newLeft = resizeInitialWrapperX;
                let newTop = resizeInitialWrapperY;
                
                const deltaX = e.clientX - resizeInitialMouseX;
                const deltaY = e.clientY - resizeInitialMouseY;

                // Apply resizing based on handle type
                // Reset transform to none before applying new top/left/width/height to avoid conflicts
                participantsIframeWrapper.style.transform = 'none';

                if (resizeHandleType.includes('e')) { // East (right)
                    newWidth = initialWidth + deltaX;
                }
                if (resizeHandleType.includes('s')) { // South (bottom)
                    newHeight = initialHeight + deltaY;
                }
                if (resizeHandleType.includes('w')) { // West (left)
                    newWidth = initialWidth - deltaX;
                    newLeft = resizeInitialWrapperX + deltaX;
                }
                if (resizeHandleType.includes('n')) { // North (top)
                    newHeight = initialHeight - deltaY;
                    newTop = resizeInitialWrapperY + deltaY;
                }

                // Apply new dimensions, respecting minimums
                participantsIframeWrapper.style.width = Math.max(newWidth, MIN_IFRAME_WIDTH) + 'px';
                participantsIframeWrapper.style.height = Math.max(newHeight, MIN_IFRAME_HEIGHT) + 'px';

                // Update position if resizing from top/left
                if (resizeHandleType.includes('n') || resizeHandleType.includes('w')) {
                    // Make sure the element does not go off-screen when resizing from top/left
                    participantsIframeWrapper.style.left = Math.max(0, Math.min(newLeft, window.innerWidth - participantsIframeWrapper.offsetWidth)) + 'px';
                    participantsIframeWrapper.style.top = Math.max(0, Math.min(newTop, window.innerHeight - participantsIframeWrapper.offsetHeight)) + 'px';
                }
            }
        }

        // Function to handle sharing participants link
        function shareParticipantsLink() {
            const urlToShare = PARTICIPANTS_IFRAME_URL;

            // Check if the Web Share API is available
            if (navigator.share) {
                navigator.share({
                    title: 'رابط المشاركين في لعبة الحروف',
                    url: urlToShare,
                }).then(() => {
                    console.log('Thanks for sharing!');
                }).catch(console.error);
            } else {
                // Fallback for browsers that do not support Web Share API
                // Copy to clipboard
                const tempInput = document.createElement('input');
                tempInput.value = urlToShare;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                // Provide a visual cue that link is copied
                const messageSpan = document.createElement('span');
                messageSpan.textContent = 'تم نسخ الرابط!';
                messageSpan.style.cssText = `
                    position: fixed;
                    bottom: 80px; /* Adjust position as needed */
                    left: 50%;
                    transform: translateX(-50%);
                    background-color: rgba(0, 0, 0, 0.8);
                    color: white;
                    padding: 8px 15px;
                    border-radius: 5px;
                    z-index: 9999;
                    opacity: 0;
                    transition: opacity 0.3s ease-in-out;
                `;
                document.body.appendChild(messageSpan);
                setTimeout(() => {
                    messageSpan.style.opacity = '1';
                }, 10); // Small delay to trigger transition
                setTimeout(() => {
                    messageSpan.style.opacity = '0';
                    messageSpan.addEventListener('transitionend', () => messageSpan.remove(), {once: true});
                }, 2000); // Hide after 2 seconds
            }
        }

        // Call the setupShareButton function during initialization (no longer needed, integrated into setupIframeControls)
        // window.addEventListener('load', setupShareButton); // Removed
    </script>
</body>
</html>
